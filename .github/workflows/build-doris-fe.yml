# GitHub Actions Workflow for Building Doris FE Modules
# 用于编译Apache Doris 3.1版本的fe-common和fe-core模块

name: Build Doris FE Modules

on:
  # 允许手动触发构建
  workflow_dispatch:
    inputs:
      doris-version:
        description: 'Doris Branch Version'
        required: true
        default: 'branch-3.1'
        type: choice
        options:
          - branch-3.1
          - branch-3.0
          - branch-2.1
  # 也可配置自动触发（可选）
  # push:
  #   branches: [ main, master ]
  # pull_request:
  #   branches: [ main, master ]

jobs:
  build-fe:
    name: Build Doris FE Modules
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java-version: [17]

    steps:
    - name: Checkout Apache Doris repository
      uses: actions/checkout@v4
      with:
        repository: apache/doris
        ref: ${{ github.event.inputs.doris-version || 'branch-3.1' }}
        submodules: recursive

    - name: Setup Java ${{ matrix.java-version }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ matrix.java-version }}
        distribution: 'temurin'

    - name: Check Java version
      run: java -version

    - name: Check Doris build script options
      run: |
        echo "=== Checking Doris build environment ==="
        chmod +x build.sh
        echo "Build script ready -> continuing to build step"

    - name: Validate FE module directories
      run: |
        echo "=== Checking FE module structure ==="
        ls -la fe/fe-common/ || echo "fe-common directory not found"
        ls -la fe/fe-core/ || echo "fe-core directory not found"
        echo "=== Current directory structure ==="
        find . -name "pom.xml" -path "*/fe/*" | head -10

    - name: Install build dependencies
      run: |
        echo "Installing missing build tools..."
        sudo apt-get update
        sudo apt-get install -y byacc bison flex libssl-dev

    - name: Build FE modules only
      run: |
        echo "Building FE modules with optimized settings..."
        JAVA_OPTS="-Xmx4g -Xms2g" ./build.sh --fe --clean

    - name: Find and list FE artifact files
      run: |
        echo "=== Generated FE Artifacts ==="
        find . -name "*.jar" -path "*/fe-common/*" -o -name "*.jar" -path "*/fe-core/*" | head -20

        echo "=== FE module target directories ==="
        find . -path "*/fe-common/target" -type d | head -5
        find . -path "*/fe-core/target" -type d | head -5

    - name: Upload FE artifacts
      uses: actions/upload-artifact@v4
      with:
        name: doris-fe-${{ github.event.inputs.doris-version || '3.1' }}-jars
        path: |
          **/fe-common/target/*.jar
          **/fe-core/target/*.jar
        retention-days: 90
        if-no-files-found: error

    - name: Upload build logs for debugging
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ github.event.inputs.doris-version || '3.1' }}
        path: |
          logs/
          **/*.log
        retention-days: 30
        if-no-files-found: ignore

  validate-artifacts:
    name: Validate Generated Artifacts
    runs-on: ubuntu-latest
    needs: build-fe

    steps:
    - name: Download FE artifacts
      uses: actions/download-artifact@v4
      with:
        name: doris-fe-${{ github.event.inputs.doris-version || '3.1' }}-jars

    - name: Validate artifact contents
      run: |
        echo "=== Downloaded Artifacts ==="
        find . -name "*.jar" -type f | while read file; do
          echo "File: $file"
          ls -lh "$file"
          # 检查jar包基本信息
          if command -v unzip >/dev/null 2>&1; then
            unzip -l "$file" | head -5 | tail -3
          else
            echo "unzip not available, skipping content check"
          fi
          echo "---"
        done

        # 检查关键文件是否存在
        fe_common_count=$(find . -name "*fe-common*.jar" | wc -l)
        fe_core_count=$(find . -name "*fe-core*.jar" | wc -l)

        echo "FE-Common JARs found: $fe_common_count"
        echo "FE-Core JARs found: $fe_core_count"

        if [ $fe_common_count -eq 0 ] || [ $fe_core_count -eq 0 ]; then
          echo "❌ Required artifacts not found!"
          exit 1
        else
          echo "✅ All required artifacts found successfully!"
        fi

# 使用说明：
# 1. 将此文件保存到项目的 .github/workflows/ 目录下
# 2. 在GitHub仓库的Actions页面手动触发构建
# 3. 选择要构建的Doris版本（默认branch-3.1）
# 4. 构建完成后在Artifacts中下载生成的jar包
# 5. 下载后可用于本地Maven安装或部署到远程仓库

# 注意：
# - 此workflow针对Doris 3.1版本优化
# - 内存使用已优化为4GB上限，适合GitHub Actions标准runner
# - 产物保留90天，可随时下载使用
